这是一个基于 Linux Ext4 文件系统架构的**高度详细且概括性**的技术汇总。

在物理层面（C 语言结构体定义），**普通文件 Inode** 和 **文件夹 Inode** 使用的是完全相同的结构体（`struct ext4_inode`）。它们的区别仅在于**属性标志位（Mode）**以及**指向的数据块内容**不同。

以下是硬核拆解：

---

### 1. 普通文件 Inode (Regular File Inode)

**核心定义**：描述实际数据的元数据容器。
**数据结构**：`struct ext4_inode` (大小通常为 256 字节)

| 字段类别      | 字段名 (C-Style)                                                                        | 详细内容与含义                                                                                                                                                                        |
| :-------- | :----------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **标识与类型** | `i_mode` (16-bit)                                                                    | **最关键字段**。<br>1. **文件类型**：标记为 `0x8000` (Regular File)。<br>2. **权限位**：存储 `rwxr-xr-x` (Owner/Group/Others)。                                                                      |
| **身份归属**  | `i_uid` / `i_gid`                                                                    | 文件的拥有者 ID (User ID) 和组 ID (Group ID)。                                                                                                                                          |
| **物理大小**  | `i_size_lo` / `i_size_high`                                                          | 文件的大小（字节数）。<br>注：Ext4 支持超大文件，所以需要高低位组合存储 64 位大小。                                                                                                                               |
| **时间戳**   | `i_atime` (Access)<br>`i_mtime` (Modify)<br>`i_ctime` (Change)<br>`i_dtime` (Delete) | - 最近访问时间。<br>- 内容修改时间（写数据）。<br>- 状态修改时间（改权限/属性）。<br>- 删除时间（用于文件恢复分析）。                                                                                                          |
| **引用计数**  | `i_links_count`                                                                      | **硬链接数**。<br>- 普通文件创建时默认为 **1**。<br>- 每增加一个硬链接，此数 +1。<br>- 当此数为 0 且无进程占用时，物理空间被释放。                                                                                             |
| **数据映射**  | `i_block[15]`<br>(60 Bytes)                                                          | **Extent Tree Root (区段树根节点)**。<br>- 不直接存数据。<br>- 存储 "Extent Header" 和 "Extent Index"。<br>- 描述规则：*"数据位于 Block 1000~1050"*。<br>- 如果文件极小（inline data），数据甚至可以直接塞在这个数组里，不占外部 Block。 |
| **属性标志**  | `i_flags`                                                                            | 特殊属性：<br>`EXT4_IMMUTABLE_FL` (不可修改/删除)<br>`EXT4_APPEND_FL` (只能追加) 等。                                                                                                           |

---

### 2. 文件夹 Inode (Directory Inode)

**核心定义**：描述“文件索引表”的元数据容器。
**物理结构**：与普通文件 Inode **完全一致**，但字段含义有特定逻辑。

| 字段类别      | 字段名 (C-Style)     | 详细内容与区别                                                                                                                       |                   |                            |               |            |
| :-------- | :---------------- | :---------------------------------------------------------------------------------------------------------------------------- | ----------------- | -------------------------- | ------------- | ---------- |
| **标识与类型** | `i_mode` (16-bit) | **关键区别**。<br>1. **文件类型**：标记为 `0x4000` (Directory)。<br>2. **权限位**：`x` 权限在这里表示**“能否进入该目录”**。                                    |                   |                            |               |            |
| **物理大小**  | `i_size`          | **占用 Block 的总大小**。<br>- 通常是 Block Size (4KB) 的倍数。<br>- *注意：这里不存目录下文件的大小总和。*                                                   |                   |                            |               |            |
| **引用计数**  | `i_links_count`   | **子目录数计算逻辑**。<br>- 新建空目录时为 **2** (来源：父目录的 `entry` + 自身的 `.` )。<br>- 每多一个子目录，计数 +1 (来源：子目录里的 `..` )。<br>- *这常用于快速判断目录下是否有子目录。* |                   |                            |               |            |
| **数据映射**  | `i_block[15]`     | **指向目录项数据块 (Directory Entries)**。<br>- 指向的数据块里存的不是用户数据，而是 **Hash B-Tree** 或 **线性列表**。<br>- 数据块内容示例：<br> `[Inode:12            | Name:"config.sys" | Type:File]`<br> `[Inode:55 | Name:"photos" | Type:Dir]` |
| **特殊性**   | -                 | 目录 Inode 不直接记录文件名，它只负责指向记录文件名的“本子”（数据块）。                                                                                      |                   |                            |               |            |

---

### 3. Superblock (超级块)

**核心定义**：文件系统的**全局配置表**与**状态寄存器**。
**位置**：固定位于分区起始的 1024 字节偏移处（及各块组的备份中）。
**数据结构**：`struct ext4_super_block`

| 字段类别      | 字段名 (C-Style)                              | 详细内容与含义                                                                                  |
| :-------- | :----------------------------------------- | :--------------------------------------------------------------------------------------- |
| **几何参数**  | `s_blocks_count`                           | 分区总共有多少个 Block（地皮总面积）。                                                                   |
|           | `s_inodes_count`                           | 分区总共有多少个 Inode（最大允许的文件数量）。                                                               |
|           | `s_log_block_size`                         | Block 的大小 (通常 4KB)。<br>计算公式：`1024 << s_log_block_size`。                                  |
| **资源状态**  | `s_free_blocks_count`                      | 当前剩余多少空闲 Block。                                                                          |
|           | `s_free_inodes_count`                      | 当前剩余多少空闲 Inode。                                                                          |
| **关键指针**  | `s_first_data_block`                       | 第一个数据块的编号。                                                                               |
|           | `s_first_ino`                              | 第一个可用的非保留 Inode 编号（通常是 11）。                                                              |
|           | `s_last_mounted`                           | 最后挂载点的路径（记录上次被挂在哪）。                                                                      |
| **健康与标识** | `s_magic`                                  | **魔数**。固定为 `0xEF53`，内核靠它识别这是 Ext 系列文件系统。                                                 |
|           | `s_state`                                  | **文件系统状态**。<br>`1` = Clean (干净/已正常卸载)<br>`2` = Error (有错误/未正常卸载，启动时需 fsck)。              |
|           | `s_uuid`                                   | 128-bit UUID，分区的全球唯一身份证。                                                                 |
|           | `s_volume_name`                            | 卷标 (Label)，如 "Data_Disk"。                                                                |
| **特性支持**  | `s_feature_compat`<br>`s_feature_incompat` | **功能特性位掩码**。<br>记录是否启用了日志 (Journal)、区段 (Extents)、64位支持等。<br>如果内核不支持 `incompat` 特性，则无法挂载。 |

---

### 总结性对比图

| 结构 | 核心职责 | 存储什么数据？ | 是否包含文件名？ | 关键区分点 |
| :--- | :--- | :--- | :--- | :--- |
| **普通文件 Inode** | 描述实体数据 | 属性 + 指向**文件内容**的指针 | **否** | `i_mode` = File |
| **文件夹 Inode** | 描述目录结构 | 属性 + 指向**目录项列表**的指针 | **否** | `i_mode` = Directory |
| **Superblock** | 描述整个分区 | 全局统计 + 配置参数 | **否** (存卷名) | 位于分区头部，独一无二 |
